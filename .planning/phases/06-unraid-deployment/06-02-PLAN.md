---
phase: 06-unraid-deployment
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/docker-publish.yml
  - .github/workflows/release.yml
autonomous: false
user_setup:
  - service: dockerhub
    why: "Docker image registry for Unraid"
    env_vars:
      - name: DOCKERHUB_USERNAME
        source: "Docker Hub account username (create account at hub.docker.com if needed)"
      - name: DOCKERHUB_TOKEN
        source: "Docker Hub -> Account Settings -> Security -> Access Tokens -> New Access Token"
    dashboard_config:
      - task: "Create repository if it doesn't exist"
        location: "Docker Hub -> Create Repository -> Name: prunerr"

must_haves:
  truths:
    - "Git tags trigger automatic Docker image builds"
    - "Docker images are built for both amd64 and arm64 architectures"
    - "Images are pushed to Docker Hub with version tags"
    - "Latest tag is updated on each release"
  artifacts:
    - path: ".github/workflows/docker-publish.yml"
      provides: "Multi-arch Docker build and push workflow"
      min_lines: 40
  key_links:
    - from: ".github/workflows/docker-publish.yml"
      to: "Dockerfile"
      via: "docker/build-push-action context"
      pattern: "context.*\\."
    - from: ".github/workflows/docker-publish.yml"
      to: "Docker Hub"
      via: "docker/login-action"
      pattern: "docker/login-action"
---

<objective>
Create GitHub Actions workflow for automated multi-architecture Docker image builds and publishing to Docker Hub.

Purpose: Unraid servers run on various hardware including AMD64 and ARM64. Automated CI/CD ensures consistent, versioned images are available for installation.

Output: GitHub Actions workflow that builds and publishes multi-arch Docker images on git tag pushes.
</objective>

<execution_context>
@~/.claude/agents/gsd-executor.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-unraid-deployment/06-RESEARCH.md

# Existing infrastructure
@Dockerfile
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GitHub Actions workflow for Docker publishing</name>
  <files>.github/workflows/docker-publish.yml</files>
  <action>
Create the .github/workflows directory if it doesn't exist, then create docker-publish.yml:

```yaml
name: Build and Push Docker Image

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to build (e.g., v1.0.0)'
        required: false
        default: 'latest'

env:
  REGISTRY: docker.io
  IMAGE_NAME: ${{ vars.DOCKERHUB_USERNAME }}/prunerr

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest,enable={{is_default_branch}}
            type=raw,value=${{ github.event.inputs.tag }},enable=${{ github.event_name == 'workflow_dispatch' }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
```

Key features:
- Triggers on version tags (v1.0.0, v2.0.0, etc.)
- Manual dispatch for testing
- Uses QEMU for ARM64 emulation
- Uses docker/metadata-action for smart tagging
- Multi-platform build (amd64 + arm64)
- GHA cache for faster subsequent builds
- Requires DOCKERHUB_USERNAME as repository variable and DOCKERHUB_TOKEN as secret
  </action>
  <verify>
```bash
test -f .github/workflows/docker-publish.yml && echo "OK: Workflow file exists"
grep -q "linux/amd64,linux/arm64" .github/workflows/docker-publish.yml && echo "OK: Multi-arch configured"
grep -q "docker/build-push-action" .github/workflows/docker-publish.yml && echo "OK: Build action configured"
grep -q "DOCKERHUB_TOKEN" .github/workflows/docker-publish.yml && echo "OK: Docker Hub auth configured"
```
  </verify>
  <done>GitHub Actions workflow created with multi-arch build and Docker Hub publishing</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>GitHub Actions workflow for automated Docker image publishing</what-built>
  <how-to-verify>
1. Review the workflow file at .github/workflows/docker-publish.yml

2. To enable the workflow, you need to configure GitHub repository settings:

   **Repository Variables** (Settings -> Secrets and variables -> Actions -> Variables):
   - `DOCKERHUB_USERNAME`: Your Docker Hub username

   **Repository Secrets** (Settings -> Secrets and variables -> Actions -> Secrets):
   - `DOCKERHUB_TOKEN`: Docker Hub access token (create at hub.docker.com -> Account Settings -> Security -> Access Tokens)

3. Test the workflow by creating a version tag:
   ```bash
   git tag v1.0.0
   git push origin v1.0.0
   ```

4. Monitor the workflow at: https://github.com/[your-username]/prunerr/actions

5. Verify the image appears on Docker Hub: https://hub.docker.com/r/[your-username]/prunerr/tags
  </how-to-verify>
  <resume-signal>Type "approved" once you've verified the workflow runs successfully, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
After workflow is configured:

1. Workflow file syntax is valid:
   ```bash
   # Install act for local testing (optional)
   # act -l  # List workflows
   ```

2. Check workflow exists in correct location:
   ```bash
   ls -la .github/workflows/docker-publish.yml
   ```

3. Verify YAML syntax:
   ```bash
   python3 -c "import yaml; yaml.safe_load(open('.github/workflows/docker-publish.yml'))" && echo "YAML is valid"
   ```
</verification>

<success_criteria>
- .github/workflows/docker-publish.yml exists with correct structure
- Workflow triggers on version tags (v*)
- Multi-arch build configured (linux/amd64,linux/arm64)
- Docker Hub authentication configured via secrets
- User has configured required secrets in GitHub
</success_criteria>

<output>
After completion, create `.planning/phases/06-unraid-deployment/06-02-SUMMARY.md`
</output>
