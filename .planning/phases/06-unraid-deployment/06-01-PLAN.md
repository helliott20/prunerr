---
phase: 06-unraid-deployment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Dockerfile
  - docker-entrypoint.sh
  - unraid-template.xml
  - assets/icon.png
autonomous: true

must_haves:
  truths:
    - "Container respects PUID/PGID environment variables for file permissions"
    - "Container health check allows sufficient startup time (10s)"
    - "Unraid template has valid, complete configuration"
    - "App icon displays correctly in Unraid UI"
  artifacts:
    - path: "docker-entrypoint.sh"
      provides: "PUID/PGID user creation and permission setup"
      min_lines: 20
    - path: "Dockerfile"
      provides: "Updated HEALTHCHECK and entrypoint"
      contains: "start-period=10s"
    - path: "unraid-template.xml"
      provides: "Finalized CA template"
      contains: "Container version=\"2\""
    - path: "assets/icon.png"
      provides: "128x128 PNG app icon"
  key_links:
    - from: "Dockerfile"
      to: "docker-entrypoint.sh"
      via: "ENTRYPOINT instruction"
      pattern: "ENTRYPOINT.*docker-entrypoint"
    - from: "unraid-template.xml"
      to: "assets/icon.png"
      via: "Icon URL"
      pattern: "Icon.*icon.png"
---

<objective>
Finalize Docker configuration for Unraid deployment with proper PUID/PGID support, improved health check timing, and polished Unraid CA template.

Purpose: Unraid users expect PUID/PGID support (standard Unraid pattern), reliable container startup without false unhealthy states, and a complete template with icon.

Output: Production-ready Dockerfile with entrypoint script, finalized Unraid XML template, and app icon.
</objective>

<execution_context>
@~/.claude/agents/gsd-executor.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-unraid-deployment/06-RESEARCH.md

# Existing infrastructure
@Dockerfile
@unraid-template.xml
@docker-compose.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Docker entrypoint script with PUID/PGID support</name>
  <files>docker-entrypoint.sh</files>
  <action>
Create a bash entrypoint script that handles PUID/PGID user management:

1. Check for PUID/PGID environment variables (default to 99/100 for Unraid)
2. Create a user with the specified UID/GID if PUID/PGID are set
3. Change ownership of /app/data to the specified user
4. Execute the main process (node dist/index.js) as the specified user using gosu or su-exec

Pattern from LinuxServer.io containers:
- If PUID/PGID match existing user (prunerr), use as-is
- If different, modify the prunerr user's UID/GID
- Use `exec` to replace shell with node process

Script should:
- Be idempotent (safe to run multiple times)
- Log what it's doing for debugging
- Fall back to defaults gracefully
- Make the script executable (chmod +x)

Note: Since Alpine doesn't have gosu by default, use su-exec (apk add su-exec) or implement with native shell commands.
  </action>
  <verify>
File exists and is executable:
```bash
test -x docker-entrypoint.sh && echo "OK: Script is executable"
```
Script contains PUID/PGID handling:
```bash
grep -q "PUID\|PGID" docker-entrypoint.sh && echo "OK: Handles PUID/PGID"
```
  </verify>
  <done>docker-entrypoint.sh exists with PUID/PGID handling logic and is executable</done>
</task>

<task type="auto">
  <name>Task 2: Update Dockerfile for entrypoint and improved health check</name>
  <files>Dockerfile</files>
  <action>
Update the Dockerfile to:

1. Install su-exec in the production stage for user switching:
   ```dockerfile
   RUN apk add --no-cache su-exec
   ```

2. Remove the USER prunerr line (entrypoint handles this dynamically)

3. Copy the entrypoint script and make it executable:
   ```dockerfile
   COPY docker-entrypoint.sh /docker-entrypoint.sh
   RUN chmod +x /docker-entrypoint.sh
   ```

4. Update HEALTHCHECK start-period from 5s to 10s (research shows 5s is too short):
   ```dockerfile
   HEALTHCHECK --interval=30s --timeout=10s --start-period=10s --retries=3 \
       CMD wget --no-verbose --tries=1 --spider http://localhost:3000/api/health || exit 1
   ```

5. Change CMD to ENTRYPOINT for the entrypoint script:
   ```dockerfile
   ENTRYPOINT ["/docker-entrypoint.sh"]
   ```

Keep all other aspects of the multi-stage build unchanged.
  </action>
  <verify>
```bash
grep -q "start-period=10s" Dockerfile && echo "OK: Health check updated"
grep -q "ENTRYPOINT" Dockerfile && echo "OK: Entrypoint configured"
grep -q "su-exec" Dockerfile && echo "OK: su-exec installed"
```
  </verify>
  <done>Dockerfile has 10s start-period, su-exec installed, and uses docker-entrypoint.sh</done>
</task>

<task type="auto">
  <name>Task 3: Finalize Unraid XML template and create app icon</name>
  <files>unraid-template.xml, assets/icon.png</files>
  <action>
1. Create assets directory and add a simple app icon:
   - Create assets/ directory
   - Generate a 128x128 PNG icon (can use ImageMagick or similar)
   - Simple design: solid background (#4F46E5 indigo) with "P" letter in white
   - Or use a placeholder from an icon set

   If no image generation available, create a placeholder text file at assets/icon.png.placeholder with instructions for the user to add their own icon.

2. Update unraid-template.xml to finalize:
   - Remove placeholder "yourusername" references - use actual GitHub username or leave as template placeholders with clear instructions
   - Update Repository to use Docker Hub path: `harrybrwn/prunerr:latest` (or appropriate username)
   - Update Icon URL to point to raw GitHub: `https://raw.githubusercontent.com/[username]/prunerr/main/assets/icon.png`
   - Update TemplateURL to point to raw GitHub
   - Remove obsolete SMTP/email configuration (Discord is now the notification method per Phase 5)
   - Add Overseerr configuration that's missing:
     ```xml
     <Config
         Name="Overseerr URL"
         Target="OVERSEERR_URL"
         Default="http://overseerr:5055"
         Mode=""
         Description="URL to your Overseerr instance (optional). Used for request tracking."
         Type="Variable"
         Display="advanced"
         Required="false"
         Mask="false">http://overseerr:5055</Config>

     <Config
         Name="Overseerr API Key"
         Target="OVERSEERR_API_KEY"
         Default=""
         Mode=""
         Description="Your Overseerr API key. Found in Overseerr under Settings > General."
         Type="Variable"
         Display="advanced"
         Required="false"
         Mask="true"></Config>
     ```
   - Add Discord webhook configuration:
     ```xml
     <Config
         Name="Discord Webhook URL"
         Target="DISCORD_WEBHOOK_URL"
         Default=""
         Mode=""
         Description="Discord webhook URL for notifications. Create in Discord Server Settings > Integrations > Webhooks."
         Type="Variable"
         Display="advanced"
         Required="false"
         Mask="true"></Config>
     ```
   - Update Overview text to mention Discord notifications (not email)
   - Remove DonateText and DonateLink if not applicable

Note: Keep PUID/PGID config as-is since entrypoint now handles it.
  </action>
  <verify>
```bash
test -d assets && echo "OK: assets directory exists"
test -f assets/icon.png -o -f assets/icon.png.placeholder && echo "OK: icon file exists"
grep -q "OVERSEERR" unraid-template.xml && echo "OK: Overseerr config added"
grep -q "DISCORD" unraid-template.xml && echo "OK: Discord config added"
! grep -q "SMTP" unraid-template.xml && echo "OK: SMTP config removed"
```
  </verify>
  <done>Unraid template has Overseerr and Discord config, no SMTP config, assets directory with icon</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Build Docker image to verify Dockerfile changes:
   ```bash
   docker build -t prunerr:test .
   ```

2. Test entrypoint with custom PUID/PGID:
   ```bash
   docker run --rm -e PUID=1000 -e PGID=1000 prunerr:test id
   ```
   Should show uid=1000 gid=1000

3. Validate XML structure:
   ```bash
   xmllint --noout unraid-template.xml && echo "XML is valid"
   ```
</verification>

<success_criteria>
- Dockerfile builds successfully with no errors
- docker-entrypoint.sh exists and handles PUID/PGID
- HEALTHCHECK uses start-period=10s
- unraid-template.xml has Discord and Overseerr config, no SMTP config
- assets/icon.png or placeholder exists
</success_criteria>

<output>
After completion, create `.planning/phases/06-unraid-deployment/06-01-SUMMARY.md`
</output>
