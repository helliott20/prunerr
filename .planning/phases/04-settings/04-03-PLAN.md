---
phase: 04-settings
plan: 03
type: execute
wave: 2
depends_on: ["04-01", "04-02"]
files_modified:
  - server/src/routes/settings.ts
  - client/src/hooks/useApi.ts
  - client/src/components/Settings/Settings.tsx
autonomous: true

must_haves:
  truths:
    - "User can export all settings to a JSON file"
    - "User can import settings from a previously exported JSON file"
    - "Import validates the file format before applying"
    - "User is warned that import will overwrite current settings"
  artifacts:
    - path: "server/src/routes/settings.ts"
      provides: "Export and import endpoints"
      contains: "router.get('/export'"
    - path: "client/src/components/Settings/Settings.tsx"
      provides: "Import/Export UI section"
      contains: "ImportExportSection"
  key_links:
    - from: "client/src/components/Settings/Settings.tsx"
      to: "GET /api/settings/export"
      via: "file download"
      pattern: "api/settings/export"
    - from: "client/src/components/Settings/Settings.tsx"
      to: "POST /api/settings/import"
      via: "file upload"
      pattern: "api/settings/import"
---

<objective>
Add settings export and import functionality allowing users to backup and restore their configuration.

Purpose: Users need to backup settings before major changes or migrate settings to a new instance. JSON export/import provides a simple, portable backup solution.

Output: Export endpoint that downloads settings as JSON, import endpoint that validates and applies settings, UI section with export button and import file picker.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-settings/04-RESEARCH.md
@server/src/routes/settings.ts
@client/src/hooks/useApi.ts
@client/src/components/Settings/Settings.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add export and import endpoints to settings API</name>
  <files>
    server/src/routes/settings.ts
  </files>
  <action>
1. Add zod schema for import validation at the top with other schemas:
```typescript
const ImportSettingsSchema = z.object({
  version: z.number(),
  exportedAt: z.string(),
  settings: z.record(z.string(), z.string()),
});
```

2. Add GET /api/settings/export endpoint (place before the /:key route to avoid route conflicts):
```typescript
// GET /api/settings/export - Export all settings as JSON file
router.get('/export', (_req: Request, res: Response) => {
  try {
    const rawSettings = settingsRepo.getAll();

    const exportData = {
      version: 1,
      exportedAt: new Date().toISOString(),
      appName: 'Prunerr',
      settings: rawSettings.reduce((acc, s) => ({
        ...acc,
        [s.key]: s.value
      }), {} as Record<string, string>),
    };

    res.setHeader('Content-Type', 'application/json');
    res.setHeader('Content-Disposition', 'attachment; filename=prunerr-settings.json');
    res.json(exportData);
  } catch (error) {
    logger.error('Failed to export settings:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to export settings',
    });
  }
});
```

3. Add POST /api/settings/import endpoint:
```typescript
// POST /api/settings/import - Import settings from JSON
router.post('/import', async (req: Request, res: Response) => {
  try {
    const parsed = ImportSettingsSchema.safeParse(req.body);
    if (!parsed.success) {
      res.status(400).json({
        success: false,
        error: 'Invalid settings file format',
        details: parsed.error.issues,
      });
      return;
    }

    const { settings } = parsed.data;

    // Convert to array format for setMultiple
    const settingsArray = Object.entries(settings).map(([key, value]) => ({
      key,
      value,
    }));

    const imported = settingsRepo.setMultiple(settingsArray);

    logger.info(`Imported ${imported.length} settings`);

    // Refresh services with new settings
    refreshServices();
    await initializeServices();

    res.json({
      success: true,
      message: `Successfully imported ${imported.length} settings`,
      data: { count: imported.length },
    });
  } catch (error) {
    logger.error('Failed to import settings:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to import settings',
    });
  }
});
```

IMPORTANT: Place these routes BEFORE the `/:key` route to prevent route conflicts. Express matches routes in order, and `export` and `import` would otherwise match the `:key` parameter.
  </action>
  <verify>
    - Server compiles: `cd /home/harry/projects/library-manager && npx tsc --noEmit -p server/tsconfig.json`
    - Test export: `curl http://localhost:3001/api/settings/export` returns JSON with version, exportedAt, settings
  </verify>
  <done>
    - GET /api/settings/export returns downloadable JSON with all settings
    - POST /api/settings/import validates and applies settings from JSON body
    - Both endpoints handle errors gracefully
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Import/Export section to Settings UI</name>
  <files>
    client/src/hooks/useApi.ts
    client/src/components/Settings/Settings.tsx
  </files>
  <action>
1. In `client/src/hooks/useApi.ts`, add import mutation hook:
```typescript
export function useImportSettings() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: async (data: { version: number; exportedAt: string; settings: Record<string, string> }) => {
      const response = await api.post<ApiResponse<{ count: number }>>('/settings/import', data);
      return response.data;
    },
    onSuccess: () => {
      // Invalidate settings to reload with new values
      queryClient.invalidateQueries({ queryKey: ['settings'] });
    },
  });
}
```

2. In `client/src/components/Settings/Settings.tsx`:

a. Add imports:
   - Import Download, Upload, FileUp, AlertTriangle from lucide-react
   - Import useImportSettings from '@/hooks/useApi'
   - Import Toast/useToast if not already available (or use window.alert for simplicity)

b. Add state for import flow:
```typescript
const [importFile, setImportFile] = useState<File | null>(null);
const [showImportConfirm, setShowImportConfirm] = useState(false);
const importMutation = useImportSettings();
```

c. Add export function:
```typescript
const handleExport = async () => {
  try {
    const response = await fetch('/api/settings/export');
    const blob = await response.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'prunerr-settings.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  } catch (error) {
    console.error('Export failed:', error);
  }
};
```

d. Add import handlers:
```typescript
const handleFileSelect = (e: React.ChangeEvent<HTMLInputElement>) => {
  const file = e.target.files?.[0];
  if (file) {
    setImportFile(file);
    setShowImportConfirm(true);
  }
};

const handleImportConfirm = async () => {
  if (!importFile) return;

  try {
    const text = await importFile.text();
    const data = JSON.parse(text);
    await importMutation.mutateAsync(data);
    setShowImportConfirm(false);
    setImportFile(null);
    // Trigger refetch to update UI with new settings
    refetch();
  } catch (error) {
    console.error('Import failed:', error);
  }
};

const handleImportCancel = () => {
  setShowImportConfirm(false);
  setImportFile(null);
};
```

e. Add Import/Export Card after Display Preferences:
```tsx
{/* Import / Export */}
<Card>
  <CardHeader>
    <div className="flex items-center gap-3">
      <div className="p-2 rounded-lg bg-amber-500/10">
        <FileUp className="w-5 h-5 text-amber-400" />
      </div>
      <div>
        <CardTitle>Backup & Restore</CardTitle>
        <CardDescription>Export settings for backup or import from a previous export</CardDescription>
      </div>
    </div>
  </CardHeader>
  <CardContent className="space-y-4">
    <div className="flex flex-col sm:flex-row gap-4">
      {/* Export Button */}
      <Button onClick={handleExport} variant="secondary" className="flex-1">
        <Download className="w-4 h-4" />
        Export Settings
      </Button>

      {/* Import Button (hidden file input) */}
      <label className="flex-1">
        <input
          type="file"
          accept=".json"
          onChange={handleFileSelect}
          className="hidden"
        />
        <Button as="span" variant="secondary" className="w-full cursor-pointer">
          <Upload className="w-4 h-4" />
          Import Settings
        </Button>
      </label>
    </div>

    <p className="text-xs text-surface-500">
      Exports include all settings including service credentials. Keep the file secure.
    </p>

    {/* Import Confirmation Dialog */}
    {showImportConfirm && (
      <div className="p-4 rounded-xl bg-amber-500/10 border border-amber-500/30">
        <div className="flex items-start gap-3">
          <AlertTriangle className="w-5 h-5 text-amber-400 shrink-0 mt-0.5" />
          <div className="flex-1">
            <p className="font-medium text-white">Confirm Import</p>
            <p className="text-sm text-surface-400 mt-1">
              Importing will overwrite all current settings with the values from <strong>{importFile?.name}</strong>. This action cannot be undone.
            </p>
            <div className="flex gap-3 mt-4">
              <Button
                onClick={handleImportConfirm}
                disabled={importMutation.isPending}
                size="sm"
              >
                {importMutation.isPending ? 'Importing...' : 'Confirm Import'}
              </Button>
              <Button
                onClick={handleImportCancel}
                variant="ghost"
                size="sm"
              >
                Cancel
              </Button>
            </div>
          </div>
        </div>
      </div>
    )}

    {/* Import Error */}
    {importMutation.isError && (
      <div className="p-4 rounded-xl bg-ruby-500/10 border border-ruby-500/30">
        <p className="text-sm text-ruby-400">
          Import failed: {importMutation.error instanceof Error ? importMutation.error.message : 'Invalid file format'}
        </p>
      </div>
    )}

    {/* Import Success */}
    {importMutation.isSuccess && (
      <div className="p-4 rounded-xl bg-emerald-500/10 border border-emerald-500/30">
        <p className="text-sm text-emerald-400">
          Settings imported successfully! The page will reload with new values.
        </p>
      </div>
    )}
  </CardContent>
</Card>
```

Note: The Button component may not support `as="span"`. If not, restructure as:
```tsx
<Button variant="secondary" className="flex-1" onClick={() => document.getElementById('import-file')?.click()}>
  <Upload className="w-4 h-4" />
  Import Settings
</Button>
<input
  id="import-file"
  type="file"
  accept=".json"
  onChange={handleFileSelect}
  className="hidden"
/>
```
  </action>
  <verify>
    - App builds: `cd /home/harry/projects/library-manager/client && npm run build`
    - Settings page shows Backup & Restore section
    - Export button downloads a .json file
    - Import shows confirmation dialog before applying
  </verify>
  <done>
    - Settings page has Backup & Restore section with Export and Import buttons
    - Export downloads prunerr-settings.json file
    - Import shows confirmation dialog warning about overwrite
    - Import success/error states displayed appropriately
  </done>
</task>

</tasks>

<verification>
After completing all tasks:
1. App builds without errors: `cd /home/harry/projects/library-manager/client && npm run build`
2. Start dev server and navigate to Settings page
3. Click "Export Settings" - downloads prunerr-settings.json
4. Open the JSON file - verify it contains version, exportedAt, appName, settings object
5. Click "Import Settings" - select the exported file
6. Verify confirmation dialog appears with filename
7. Click "Confirm Import" - verify success message
8. Refresh page - settings still present
9. Test with invalid file - verify error message displayed
</verification>

<success_criteria>
- Export downloads valid JSON file with all settings
- Import validates file format before applying
- Confirmation dialog warns about overwriting
- Success and error states clearly communicated to user
- Settings correctly applied after import
</success_criteria>

<output>
After completion, create `.planning/phases/04-settings/04-03-SUMMARY.md`
</output>
