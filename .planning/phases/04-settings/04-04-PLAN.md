---
phase: 04-settings
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - server/src/routes/settings.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Display preferences persist across page refreshes"
    - "GET /api/settings returns display field with user preferences"
    - "PUT /api/settings saves display field to database"
  artifacts:
    - path: "server/src/routes/settings.ts"
      provides: "Display settings parsing in GET endpoint"
      contains: "display_"
    - path: "server/src/routes/settings.ts"
      provides: "Display settings saving in PUT endpoint"
      contains: "settings.display"
  key_links:
    - from: "GET /api/settings"
      to: "settings database"
      via: "Parse display_ prefixed keys"
      pattern: "display_"
    - from: "PUT /api/settings"
      to: "settings database"
      via: "Save display settings with prefix"
      pattern: "display_"
---

<objective>
Fix display preferences persistence - backend GET and PUT endpoints must handle the display field.

Purpose: Phase 04-01 created the DisplayPreferencesContext that sends display settings to the backend, but the backend ignores them. This gap closure adds the missing display_ parsing to GET and display field saving to PUT, enabling preferences to persist across page refreshes.

Output: Backend settings routes handle display field, preferences persist correctly.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-settings/04-VERIFICATION.md
@server/src/routes/settings.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add display settings parsing to GET /api/settings</name>
  <files>server/src/routes/settings.ts</files>
  <action>
In `server/src/routes/settings.ts`, modify the GET '/' handler (around lines 42-79) to parse display_ prefixed settings:

1. Add a display object alongside services, notifications, schedule:
```typescript
const display: Record<string, string> = {};
```

2. In the for loop that iterates over rawSettings, add parsing for display_ prefix (after the schedule_ block, around line 79):
```typescript
// Parse display settings
if (key.startsWith('display_')) {
  const field = key.replace('display_', '');
  display[field] = value;
  continue;
}
```

3. Update the response to include display:
```typescript
res.json({
  success: true,
  data: {
    services,
    notifications,
    schedule,
    display,  // Add this
  },
});
```
  </action>
  <verify>
    - TypeScript compiles: `cd /home/harry/projects/library-manager/server && npx tsc --noEmit`
    - Grep confirms display_ parsing: `grep -n "display_" server/src/routes/settings.ts`
  </verify>
  <done>
    - GET /api/settings response includes display field
    - display_ prefixed keys are parsed from database
  </done>
</task>

<task type="auto">
  <name>Task 2: Add display settings saving to PUT /api/settings</name>
  <files>server/src/routes/settings.ts</files>
  <action>
In `server/src/routes/settings.ts`, modify the PUT '/' handler (around lines 247-256) to save display settings:

Add a block after the schedule saving section (after line 256, before the logger.info call):

```typescript
// Save display configuration
if (settings.display) {
  for (const [field, value] of Object.entries(settings.display)) {
    if (value !== undefined && value !== null) {
      const key = `display_${field}`;
      settingsRepo.set({ key, value: String(value) });
      savedSettings.push({ key, value: String(value) });
    }
  }
}
```

This follows the exact same pattern as services, notifications, and schedule saving.
  </action>
  <verify>
    - TypeScript compiles: `cd /home/harry/projects/library-manager/server && npx tsc --noEmit`
    - Grep confirms display saving: `grep -n "settings.display" server/src/routes/settings.ts`
  </verify>
  <done>
    - PUT /api/settings saves display field to database with display_ prefix
    - Display settings persist across server restarts
  </done>
</task>

</tasks>

<verification>
After completing all tasks:
1. Server compiles: `cd /home/harry/projects/library-manager/server && npx tsc --noEmit`
2. Start the application
3. Navigate to Settings, change a display preference (e.g., date format to "ISO")
4. Refresh the page
5. Verify the preference persisted (date format still shows "ISO")
6. Check database directly if needed: settings table should have display_dateFormat, display_timeFormat, display_fileSizeUnit keys
</verification>

<success_criteria>
- Display preferences persist across page refreshes
- GET /api/settings returns display object with dateFormat, timeFormat, fileSizeUnit
- PUT /api/settings saves display settings to database
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-settings/04-04-SUMMARY.md`
</output>
