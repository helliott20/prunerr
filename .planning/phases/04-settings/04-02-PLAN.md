---
phase: 04-settings
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - client/src/components/Settings/Settings.tsx
  - client/src/types/index.ts
  - server/src/routes/settings.ts
autonomous: true

must_haves:
  truths:
    - "User can configure scan frequency (hourly, daily, weekly)"
    - "User can select which day of week for weekly scans"
    - "User can set the time of day for scans"
    - "Schedule changes take effect immediately without restart"
  artifacts:
    - path: "client/src/components/Settings/Settings.tsx"
      provides: "Enhanced schedule configuration UI"
      contains: "dayOfWeek"
    - path: "client/src/types/index.ts"
      provides: "Updated ScheduleSettings with dayOfWeek"
      contains: "dayOfWeek"
  key_links:
    - from: "client/src/components/Settings/Settings.tsx"
      to: "PUT /api/settings"
      via: "saveMutation"
      pattern: "handleScheduleChange"
    - from: "server/src/routes/settings.ts"
      to: "scheduler"
      via: "updateSchedule call"
      pattern: "updateSchedule|initializeServices"
---

<objective>
Enhance the scan schedule configuration UI with day-of-week selection for weekly scans and improved UX.

Purpose: The current schedule section is basic. Users with weekly scans need to select which day, and the UI could be clearer about what each option means.

Output: Enhanced Schedule section in Settings with day picker for weekly frequency, clearer labels, and immediate scheduler updates when settings change.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-settings/04-RESEARCH.md
@client/src/components/Settings/Settings.tsx
@client/src/types/index.ts
@server/src/routes/settings.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add dayOfWeek to ScheduleSettings and update backend to handle it</name>
  <files>
    client/src/types/index.ts
    server/src/routes/settings.ts
  </files>
  <action>
1. In `client/src/types/index.ts`, update ScheduleSettings:
```typescript
export interface ScheduleSettings {
  enabled: boolean;
  interval: 'hourly' | 'daily' | 'weekly';
  time: string;
  dayOfWeek?: number;  // 0-6, Sunday=0, only used when interval='weekly'
  autoProcess: boolean;
}
```

2. In `server/src/routes/settings.ts`, the PUT / endpoint already handles schedule settings generically. No changes needed - the key-value storage will automatically handle schedule_dayOfWeek.

3. Verify the scheduler integration: Check that when settings are saved, the scheduler is notified. The current code calls `refreshServices()` and `initializeServices()` when service settings change. For schedule changes, we need to ensure the scheduler picks up new settings.

Look at the existing code - if scheduler is not being updated on schedule changes, add a call to update it. The scheduler should read from settings on each run or be explicitly notified.

Note: Based on research, the scheduler already reads settings on each task run, so explicit notification may not be needed. Verify this works correctly.
  </action>
  <verify>
    - TypeScript compiles: `cd /home/harry/projects/library-manager/client && npx tsc --noEmit`
    - ScheduleSettings includes dayOfWeek field
  </verify>
  <done>
    - ScheduleSettings type includes optional dayOfWeek (0-6)
    - Backend correctly persists schedule_dayOfWeek setting
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance Schedule section UI with day-of-week picker and improved labels</name>
  <files>
    client/src/components/Settings/Settings.tsx
  </files>
  <action>
1. Update handleScheduleChange to include dayOfWeek in the merge:
```typescript
const handleScheduleChange = (field: keyof NonNullable<SettingsType['schedule']>, value: string | number | boolean) => {
  setLocalSettings((prev) => ({
    ...prev,
    schedule: {
      enabled: prev.schedule?.enabled ?? currentSettings.schedule?.enabled ?? false,
      interval: prev.schedule?.interval ?? currentSettings.schedule?.interval ?? 'daily',
      time: prev.schedule?.time ?? currentSettings.schedule?.time ?? '00:00',
      dayOfWeek: prev.schedule?.dayOfWeek ?? currentSettings.schedule?.dayOfWeek ?? 0,
      autoProcess: prev.schedule?.autoProcess ?? currentSettings.schedule?.autoProcess ?? false,
      [field]: value,
    },
  }));
};
```

2. In the Scan Schedule Card, when enabled is true:
   - Change from 2-column grid to responsive grid that accommodates 3 items when weekly is selected
   - Add day-of-week select ONLY when interval is 'weekly':
     ```tsx
     {currentSettings.schedule?.interval === 'weekly' && (
       <div className="space-y-2">
         <label className="block text-sm font-medium text-surface-200">
           Day of Week
         </label>
         <select
           value={currentSettings.schedule?.dayOfWeek ?? 0}
           onChange={(e) => handleScheduleChange('dayOfWeek', parseInt(e.target.value))}
           className="select"
         >
           <option value={0}>Sunday</option>
           <option value={1}>Monday</option>
           <option value={2}>Tuesday</option>
           <option value={3}>Wednesday</option>
           <option value={4}>Thursday</option>
           <option value={5}>Friday</option>
           <option value={6}>Saturday</option>
         </select>
       </div>
     )}
     ```

3. Update the interval select options to be more descriptive:
   - "Every Hour" -> "Every hour (at :00)"
   - "Daily" -> "Once per day"
   - "Weekly" -> "Once per week"

4. Add helper text below the time input explaining what it means:
   ```tsx
   <p className="text-xs text-surface-500 mt-1">
     {currentSettings.schedule?.interval === 'hourly'
       ? 'Scan will run at this minute past each hour'
       : 'Scan will run at this time'}
   </p>
   ```

5. Update grid layout to be responsive:
   - When interval is weekly: 3 columns on md+ (interval, day, time)
   - Otherwise: 2 columns on md+ (interval, time)
   ```tsx
   <div className={cn(
     'grid gap-4 pl-4 border-l-2 border-emerald-500/30',
     currentSettings.schedule?.interval === 'weekly'
       ? 'grid-cols-1 md:grid-cols-3'
       : 'grid-cols-1 md:grid-cols-2'
   )}>
   ```
  </action>
  <verify>
    - App builds: `cd /home/harry/projects/library-manager/client && npm run build`
    - Settings page shows enhanced schedule section
    - Day picker appears only when Weekly is selected
  </verify>
  <done>
    - Schedule section has improved interval labels
    - Day-of-week selector appears when weekly interval is selected
    - Time input has helper text explaining its purpose
    - Grid layout adapts to show 2 or 3 columns based on interval
  </done>
</task>

</tasks>

<verification>
After completing all tasks:
1. App builds without errors: `cd /home/harry/projects/library-manager/client && npm run build`
2. Start dev server and navigate to Settings page
3. Enable Automatic Scanning toggle
4. Select "Once per week" from interval dropdown
5. Verify Day of Week dropdown appears
6. Select a day and time, click Save
7. Verify settings persist on page refresh
8. Check /api/settings response includes schedule_dayOfWeek
</verification>

<success_criteria>
- ScheduleSettings type includes dayOfWeek field
- Day-of-week picker appears when weekly interval selected
- Schedule changes persist to backend correctly
- UI has improved labels and helper text
</success_criteria>

<output>
After completion, create `.planning/phases/04-settings/04-02-SUMMARY.md`
</output>
