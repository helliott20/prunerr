---
phase: 02-activity-logging
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - client/src/services/api.ts
  - client/src/hooks/useApi.ts
  - client/src/types/index.ts
  - client/src/components/ActivityLog/ActivityLog.tsx
  - client/src/App.tsx
  - client/src/components/Layout/Sidebar.tsx
autonomous: true

must_haves:
  truths:
    - "User can navigate to Activity Log page from sidebar"
    - "User sees timestamped activities in reverse chronological order"
    - "User can filter activities by event type"
    - "User can filter activities by actor type (scheduler/user/rule)"
    - "User can see actor attribution on each activity entry"
    - "User can paginate through activity history"
  artifacts:
    - path: "client/src/components/ActivityLog/ActivityLog.tsx"
      provides: "Activity Log page component"
      min_lines: 150
    - path: "client/src/services/api.ts"
      provides: "Activity API functions"
      contains: "activityApi"
    - path: "client/src/hooks/useApi.ts"
      provides: "useActivityLog hook"
      contains: "useActivityLog"
    - path: "client/src/App.tsx"
      provides: "Activity route"
      contains: "/activity"
  key_links:
    - from: "client/src/components/ActivityLog/ActivityLog.tsx"
      to: "/api/activity"
      via: "useActivityLog hook"
      pattern: "useActivityLog\\("
    - from: "client/src/components/Layout/Sidebar.tsx"
      to: "/activity"
      via: "navigation array"
      pattern: "href.*activity"
---

<objective>
Create the Activity Log frontend page with filtering, pagination, and clear actor attribution.

Purpose: Provide users with complete visibility into what the system is doing and has done, with clear distinction between automated and manual actions.

Output: Activity Log component accessible from sidebar navigation, displaying timestamped activities with actor attribution, event type filtering, and pagination.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-activity-logging/02-RESEARCH.md
@.planning/phases/02-activity-logging/02-01-SUMMARY.md

Key patterns:
- Follow History.tsx for page structure (filters, table, pagination)
- Use EmptyState and ErrorState components from Phase 1
- Use existing formatRelativeTime and formatDate from lib/utils
- Actor type badges: scheduler (blue), user (purple), rule (amber)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add activity types, API, and hook</name>
  <files>
    client/src/types/index.ts
    client/src/services/api.ts
    client/src/hooks/useApi.ts
  </files>
  <action>
Update client/src/types/index.ts - add activity types:

```typescript
export interface ActivityLogEntry {
  id: number;
  eventType: 'scan' | 'deletion' | 'rule_match' | 'protection' | 'manual_action' | 'error';
  action: string;
  actorType: 'scheduler' | 'user' | 'rule';
  actorId: string | null;
  actorName: string | null;
  targetType: string | null;
  targetId: number | null;
  targetTitle: string | null;
  metadata: Record<string, unknown> | null;
  createdAt: string;
}

export interface ActivityFilters {
  page: number;
  limit: number;
  dateRange: '24h' | '7d' | '30d' | 'all';
  eventTypes?: string[];
  actorTypes?: string[];
  search?: string;
}

export interface ActivityLogResponse {
  items: ActivityLogEntry[];
  total: number;
  page: number;
  limit: number;
}
```

Update client/src/services/api.ts - add activity API:

```typescript
// Activity APIs
export const activityApi = {
  getLog: async (filters: ActivityFilters): Promise<ActivityLogResponse> => {
    const params = new URLSearchParams();
    params.append('page', String(filters.page));
    params.append('limit', String(filters.limit));
    params.append('dateRange', filters.dateRange);
    if (filters.search) params.append('search', filters.search);
    if (filters.eventTypes?.length) params.append('eventTypes', filters.eventTypes.join(','));
    if (filters.actorTypes?.length) params.append('actorTypes', filters.actorTypes.join(','));

    const { data } = await api.get<ApiResponse<ActivityLogResponse>>(`/activity?${params}`);
    return data.data!;
  },
};
```

Update client/src/hooks/useApi.ts - add activity hook:

1. Import ActivityFilters type
2. Add query key: activityLog: (filters: ActivityFilters) => ['activity', 'log', filters] as const,
3. Add hook:
```typescript
export function useActivityLog(filters: ActivityFilters) {
  return useQuery({
    queryKey: queryKeys.activityLog(filters),
    queryFn: () => activityApi.getLog(filters),
  });
}
```
  </action>
  <verify>
TypeScript compiles: `cd /home/harry/projects/library-manager && npm run build --workspace=client`
  </verify>
  <done>
ActivityLogEntry, ActivityFilters, ActivityLogResponse types defined, activityApi.getLog function exists, useActivityLog hook exported
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ActivityLog component</name>
  <files>
    client/src/components/ActivityLog/ActivityLog.tsx
  </files>
  <action>
Create client/src/components/ActivityLog/ActivityLog.tsx following the History.tsx pattern:

Structure:
1. Header with title "Activity Log" and description "System events and actions"

2. Filter bar (in a Card):
   - Search input for target_title search
   - Date range dropdown (24h, 7d, 30d, all) - default to '7d'
   - Event type multi-select or dropdown (scan, deletion, rule_match, protection, manual_action, error)
   - Actor type filter buttons/dropdown (All, Scheduler, User, Rule)

3. Activity list (in a Card with table):
   - Columns: Event, Actor, Target, Time
   - Event column: Icon based on eventType + action text
     - scan: PlayCircle icon (blue)
     - deletion: Trash2 icon (ruby)
     - rule_match: ListFilter icon (amber)
     - protection: Shield icon (emerald)
     - manual_action: User icon (purple)
     - error: AlertCircle icon (ruby)
   - Actor column: Badge with actorType color + actorName
     - scheduler: blue badge
     - user: purple badge
     - rule: amber badge
   - Target column: targetTitle (or "-" if null)
   - Time column: formatRelativeTime + formatDate in smaller text

4. Use EmptyState component for empty states:
   - variant="filtered" when filters applied but no results
   - Default variant when no activity at all

5. Use ErrorState component for API errors

6. Pagination at bottom (same pattern as History.tsx)

Import icons from lucide-react: Activity, PlayCircle, Trash2, ListFilter, Shield, User, AlertCircle, Clock, Search, Filter, ChevronLeft, ChevronRight

Use Badge component for actor type display.
Use Card, Button, Input components.
Use formatRelativeTime, formatDate from lib/utils.
  </action>
  <verify>
TypeScript compiles and component renders:
```bash
cd /home/harry/projects/library-manager && npm run build --workspace=client
```
  </verify>
  <done>
ActivityLog.tsx renders activity list with event icons, actor badges, target titles, timestamps, filtering by event/actor type, search, date range, and pagination
  </done>
</task>

<task type="auto">
  <name>Task 3: Add route and navigation</name>
  <files>
    client/src/App.tsx
    client/src/components/Layout/Sidebar.tsx
  </files>
  <action>
Update client/src/App.tsx:

1. Import ActivityLog: `import ActivityLog from './components/ActivityLog/ActivityLog';`
2. Add route after /history: `<Route path="/activity" element={<ActivityLog />} />`

Update client/src/components/Layout/Sidebar.tsx:

1. Import Activity icon from lucide-react (add to existing import)
2. Add to navigation array after History entry:
   ```typescript
   { name: 'Activity', href: '/activity', icon: Activity },
   ```

The navigation order should be:
- Dashboard
- Library
- Rules
- Queue
- History
- Activity  <-- new
- Settings
  </action>
  <verify>
1. Build succeeds: `cd /home/harry/projects/library-manager && npm run build --workspace=client`
2. Start dev server and verify Activity appears in sidebar
3. Click Activity and verify page renders
  </verify>
  <done>
/activity route configured, Activity nav item appears in sidebar between History and Settings, clicking it loads ActivityLog component
  </done>
</task>

</tasks>

<verification>
1. TypeScript builds without errors for client workspace
2. ActivityLog component exists with proper structure
3. useActivityLog hook exists and is exported
4. Activity route accessible at /activity
5. Activity nav item visible in sidebar
6. Empty state displays when no activities (expected for fresh install)
7. Filters and pagination controls render correctly
</verification>

<success_criteria>
- Activity Log page accessible from navigation
- Page shows activities in reverse chronological order
- Event type icons distinguish different event types
- Actor badges show scheduler/user/rule attribution
- Filters work: date range, event types, actor types, search
- Pagination works for large activity lists
- Empty states and error states handled properly
</success_criteria>

<output>
After completion, create `.planning/phases/02-activity-logging/02-02-SUMMARY.md`
</output>
